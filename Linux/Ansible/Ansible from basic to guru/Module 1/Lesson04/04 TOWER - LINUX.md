Тэги: #tower #awx 
Ссылки:  https://habr.com/ru/companies/pixonic/articles/352184/
## ТРЕБОВАНИЯ К РАБОТЕ ANSIBLE TOWER
ВМ AWX плохо отнеслась к тому что поставил ее на паузу (см. урок 1, настройка AWX). Перезапуск не помог. Пришлось откатываться на снапшот.
- имена машин разрешаются по DNS
- настроена авторизация и доступ по ssh на управляемые ноды (Lesson01/LAB05 Linux)
![[Pasted image 20240213104106.png]]

## MAIN COMPONENTS TOWER
![[Pasted image 20240213120853.png]]

Соответствие с AWX
![[Pasted image 20240213121117.png]]


## БАЗОВАЯ НАСТРОЙКА
1. Projects
Projects в терминологии AWX означает набор плейбуков, которые расположены локально на сервере с AWX или в репозитории. Реквизиты:
     - Name: имя проекта, пускай это будет firstproject.  
     - Organization: в AWX это сущность, которая используется для разграничения доступа. К Organization могут относиться инвентори, пользователи, группы пользователей, плейбуки. Выберем Default.
     - SCM TYPE: тип репозитория, может быть либо локальная директория, либо одна из систем контроля версий на выбор: git, mercurial, subversion. 
     - SCM Url: урл для репозитория.  
     - SCM branch/tag/commit: опционально можно указать необходимый branch/tag/commit.  
     - В поле SCM credentials можно выбрать реквизиты, которые будут использоваться для доступа к репозиторию.  

Также можно отметить галочками чекбоксы:  
     - Clean: удалить все локальные изменения перед обновлением.  
     - Delete on Update: при обновлении Project'а удалять локальную копию и заново загружать новую копию репозитория.  
     - Update on Launch: при каждом запуске плейбука из этого Project'а обновлять локальную копию репозитория до актуальной версии. Можно использовать в связке с Delete on Update, но это может привести к более долгому выполнению плейбука, так как каждый раз потребуется ждать окончания синхронизации с репозиторием.  
  
Выберем Clean и Update on Launch. Нажимаем Save и после этого создание нашего первого Project'а завершено. Нажмем на кнопку Start an scm update. Дождемся завершения первой загрузки нашего репозитория (следить за статусом обновления можно в разделе Jobs).

Надо создать заранее пользователя (Credential), типа Source control
![[Pasted image 20240226234244.png]]
Затем добавить проект для собственного git:
![[Pasted image 20240226234123.png]]


2. Добавил организацию
Cущность, которая используется для разграничения доступа. К Organization могут относиться инвентори, пользователи, группы пользователей, плейбуки.

![[Pasted image 20240214085718.png]]

3. Добавил пользователя
![[Pasted image 20240214085817.png]]

4. Добавил inventory
На выбор будет предложено создать:  
     - Inventory: обычный Inventory.  
     - Smart Inventory: позволяет генерировать inventory на основе уже существующих хостов, основываясь на каких-либо параметрах, например, на типе операционной системы.
Сохраняем и возвращаемся в раздел Inventory. Наш Inventory появился в списке. Перейдем в него: после создания верхние вкладки стали активны.  
     - Permissions: здесь контролируется, кто из пользователей или групп пользователей имеет доступ к Inventory.  
     - Groups: список хост-групп.  
     - Hosts: список хостов.  
     - Sources: список источников для Inventory. Можно выгружать инвентори из AWS/Azure/OpenStack/RHEV и ещё ряда сервисов, можно указать инвентори файл, который находится внутри нашего Project'а или же указать в качестве источника свой собственный скрипт, который генерирует Dynamic Inventory.  
     - Completed Jobs: список запущенных плейбуков, ассоциированных с хостами из текущего Inventory.


![[Pasted image 20240214091411.png]]

5. Добавил в inventory хосты
Inventory заполняем руками, так как у нас мало хостов. Перейдем во вкладку Hosts и создадим несколько хостов. После создания хостов перейдем во вкладку Groups и создадим группы для наших хостов.
На вкладках Hosts и Groups также доступна кнопка Run command. Это аналог [ad-hoc команд](http://docs.ansible.com/ansible/latest/user_guide/intro_adhoc.html) в Ansible, которые позволяют выполнить действия на удаленных хостах, без плейбука.

![[Pasted image 20240214090009.png]]
![[Pasted image 20240214091444.png]]

6. добавил credentials ДЛЯ ЗАПУСКА ПЛЕЙБУКА
     - Name: укажем имя для наших реквизитов.  
     - Credential Type: здесь можно выбрать тип реквизитов. Нас интересует Machine, чтобы использовать их для доступа к нашим серверам. Помимо этого AWX предлагает множество разных типов реквизитов доступа, которые можно использовать для интеграции с различными сервисами, такими как scm (git, svn, mercurial), Red Hat Insight, AWS, Azure, Red Hat Satellite, RHEV, Vmware, OpenStack. А ещё можно создавать свои собственные типы credentials.  
     - Имя пользователя: выберем root.  
     - Пароль: оставляем пустым, так как мы будем использовать доступ по ключу.  
     - PRIVATE KEY PASSPHRASE: пароль для ключа, если ключ создан с паролем. В нашем случае ключ без пароля, поэтому поле оставляем пустым.  
     - PRIVILEGE ESCALATION METHOD: метод повышения привилегий. Например: sudo, su, pfexec и и т.д.  
     - PRIVILEGE ESCALATION USERNAME: пользователь, под которым Ansible должен получить привилегии.  
     - PRIVILEGE ESCALATION PASSWORD: пароль для повышения привилегий.  
  
Поля, связанные с эскалацией привилегий, оставим пустыми, так как мы будем логиниться под root.  
  
Обратите внимание: у ряда полей есть чекбокс Prompt on launch. При активации этого чекбокса соответствующее ему поле будет предложено заполнить вручную при каждом запуске плейбука, с которым ассоциированы данные реквизиты. Таким образом можно не сохранять пароль внутри AWX, а запрашивать его при каждом запуске плейбука.

![[Pasted image 20240214090356.png]]
7. В свойствах тестового template указал созданные объекты.
В терминологии AWX Template — это набор параметров, которые используются для запуска плейбука. 
Пример создания template на основе созданного ранее project
![[Pasted image 20240226234545.png]]
В минимальном виде необходимо указать имя шаблона, выбрать project, выбрать playbook, выбрать inventory. 
     - Name и Description: имя и описание шаблона.  
     - Job Type: Run или Check. То есть запуск плейбука или только проверка плейбука (dry-run) без внесения изменений.  
     - Inventory: Inventory, с которым будет запускаться плейбук.  
     - Project и Playbook: предназначены для выбора Project'а с плейбуками и конкретного плейбука из Project'а.  
     - Limit: список хостов и групп, на которых будет запущен плейбук.  
     - Verbosity: насколько подробно Ansible будет выводить результат выполнения (аналог ключей -v -vv -vvv).  
     - Job tags: список тегов — задачи, с которыми должны быть запущены. Если не указывать, будет выполнены все задачи описанные в ролях.  
     - Skip tags: список тегов — задачи, с которыми не будут выполняться.  
     - Labels: метки, которые будут ассоциироваться с данным шаблоном. Можно использовать для фильтрации в самом AWX.  
     - Show diff: показывать изменения, которые делает Ансибл (аналог ключа --diff).  
  
Сохраняем проект, возвращаемся в раздел Templates, и запускаем наш плейбук (кнопка в виде ракеты):

![[Pasted image 20240214090525.png]]
При необходимости, в свойствах темплейта задаем параметры отвечающие за логгирование выводимых сообщений (аналог -vvv)
![[Pasted image 20240217211912.png]]
7. template запустил на отработку
![[Pasted image 20240214090618.png]]

9. 