https://yandex.cloud/ru/docs/tutorials/routing/usergate-proxy?utm_referrer=https%3A%2F%2Fwww.google.com%2F

Создание и настройка шлюза UserGate в режиме прокси-сервера
Статья создана
Yandex Cloud
Обновлена 24 декабря 2024 г.

UserGate

— это межсетевой экран нового поколения от одноименной российской компании.

Вы создадите виртуальную машину UserGate в Yandex Cloud и настроите шлюз в режиме прокси-сервера. Это позволит организовать безопасный доступ в интернет для сотрудников вашей компании из любой точки мира (офис, дом, кафе и прочие публичные места). Для более расширенного изучения возможностей UserGate пройдите бесплатный курс UserGate Getting Started

.

Типовая схема использования UserGate в режиме прокси-сервера в Yandex Cloud представлена на рисунке ниже.

Чтобы развернуть шлюз UserGate:

    Подготовьте облако к работе.
    Создайте облачную сеть и подсеть.
    Зарезервируйте статический публичный IP-адрес.
    Создайте виртуальную машину UserGate.
    Настройте UserGate NGFW через веб-консоль администратора.

Если созданные ресурсы вам больше не нужны, удалите их.
Перед началом работы

Зарегистрируйтесь в Yandex Cloud и создайте платежный аккаунт:

    Перейдите в консоль управления

, затем войдите в Yandex Cloud или зарегистрируйтесь.
На странице Yandex Cloud Billing

    убедитесь, что у вас подключен платежный аккаунт, и он находится в статусе ACTIVE или TRIAL_ACTIVE. Если платежного аккаунта нет, создайте его и привяжите к нему облако.

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша инфраструктура, на странице облака

.

Подробнее об облаках и каталогах.
Необходимые платные ресурсы

В стоимость поддержки шлюза UserGate входит:

    плата за постоянно запущенную виртуальную машину (см. тарифы Yandex Compute Cloud);
    плата за использование UserGate NGFW;
    плата за использование публичного статического IP-адреса (см. тарифы Yandex Virtual Private Cloud).

Создайте облачную сеть и подсеть

Создайте облачную сеть с подсетями в тех зонах доступности, где будет находиться виртуальная машина.

    На странице каталога в консоли управления

    в правом верхнем углу нажмите кнопку Создать ресурс и выберите пункт Сеть.
    Задайте имя сети: usergate-network.
    В поле Дополнительно включите опцию Создать подсети.
    Нажмите кнопку Создать сеть.

Создайте группу безопасности

    В консоли управления

перейдите на страницу каталога, в котором нужно создать группу.

В списке сервисов выберите Virtual Private Cloud.

На панели слева выберите

    Группы безопасности.

    Нажмите кнопку Создать группу безопасности.

    Введите имя группы безопасности — usergate-sg.

    В поле Сеть выберите сеть usergate-network.

    В блоке Правила создайте правила по инструкции под таблицей:
    Направление
    трафика 	Описание 	Диапазон портов 	Протокол 	Назначение /
    Источник 	CIDR блоки
    Исходящий 	any 	Весь 	Любой 	CIDR 	0.0.0.0/0
    Входящий 	icmp 	Весь 	ICMPv6 	CIDR 	0.0.0.0/0
    Входящий 	rdp 	3389 	TCP 	CIDR 	0.0.0.0/0
    Входящий 	ssh 	22 	TCP 	CIDR 	0.0.0.0/0
    Входящий 	usergate 8001 	8001 	TCP 	CIDR 	0.0.0.0/0
    Входящий 	usergate 8090 	8090 	TCP 	CIDR 	0.0.0.0/0
        Перейдите на вкладку Исходящий трафик или Входящий трафик.
        Нажмите кнопку Добавить правило. В открывшемся окне:

            В поле Диапазон портов укажите один порт или диапазон портов, куда или откуда будет поступать трафик.

            В поле Протокол укажите нужный протокол или оставьте Любой, чтобы разрешить передачу трафика по всем протоколам.

            В поле Назначение или Источник выберите назначение правила:
                CIDR — правило будет применено к диапазону IP-адресов. В поле CIDR блоки укажите CIDR и маски подсетей, в которые или из которых будет поступать трафик. Чтобы добавить несколько CIDR, нажимайте кнопку Добавить CIDR.
                Группа безопасности — правило будет применено к ВМ из текущей группы или из выбранной группы безопасности.

            Нажмите кнопку Сохранить.

    Нажмите кнопку Сохранить.

Зарезервируйте статический публичный IP-адрес

Для работы шлюзу потребуется статический публичный IP-адрес.

    В консоли управления

перейдите на страницу каталога, в котором нужно зарезервировать адрес.
В списке сервисов выберите Virtual Private Cloud.
На панели слева выберите

    IP-адреса.
    Нажмите кнопку Зарезервировать адрес.
    В открывшемся окне в поле Зона доступности выберите зону доступности ru-central1-d.
    Нажмите кнопку Зарезервировать.

Создайте виртуальную машину UserGate

    На странице каталога в консоли управления

нажмите кнопку Создать ресурс и выберите Виртуальная машина.

В блоке Образ загрузочного диска в поле Поиск продукта введите UserGate NGFW и выберите публичный образ UserGate NGFW.

В блоке Расположение выберите зону доступности ru-central1-d.

В блоке Вычислительные ресурсы перейдите на вкладку Своя конфигурация и укажите необходимую платформу, количество vCPU и объем RAM:

    Платформа — Intel Ice Lake.
    vCPU — 4.
    Гарантированная доля vCPU — 100%.
    RAM — 8 ГБ.

Примечание

Указанные параметры подойдут для функционального тестирования шлюза. Чтобы рассчитать параметры для более серьезной нагрузки, ознакомьтесь с официальными рекомендациями

UserGate.

В блоке Сетевые настройки:

    В поле Подсеть выберите сеть usergate-network и подсеть usergate-subnet-ru-central1-d.
    В поле Публичный адрес выберите Список и в появившемся списке выберите зарезервированный ранее IP-адрес.
    В поле Группы безопасности выберите из списка группу usergate-sg.

В блоке Доступ выберите вариант SSH-ключ и укажите данные для доступа на ВМ:

    В поле Логин введите имя пользователя. Не используйте имя root или другие имена, зарезервированные ОС. Для выполнения операций, требующих прав суперпользователя, используйте команду sudo.

    В поле SSH-ключ выберите SSH-ключ, сохраненный в вашем профиле пользователя организации.

    Если в вашем профиле нет сохраненных SSH-ключей или вы хотите добавить новый ключ:
        Нажмите кнопку Добавить ключ.
        Задайте имя SSH-ключа.
        Загрузите или вставьте содержимое открытого SSH-ключа. Пару SSH-ключей для подключения к ВМ по SSH необходимо создать самостоятельно.
        Нажмите кнопку Добавить.

    SSH-ключ будет добавлен в ваш профиль пользователя организации.

    Если в организации отключена возможность добавления пользователями SSH-ключей в свои профили, добавленный открытый SSH-ключ будет сохранен только в профиле пользователя создаваемой виртуальной машины.

В блоке Общая информация задайте имя ВМ: usergate-proxy.

Нажмите кнопку Создать ВМ.

Настройте UserGate NGFW через веб-консоль администратора

Для настройки шлюза перейдите в веб-консоль администратора UserGate NGFW по адресу https://<публичный_IP-адрес_ВМ>:8001 и авторизуйтесь с данными по умолчанию: логин — Admin, пароль — utm.

После авторизации вам будет предложено изменить пароль по умолчанию и провести обновление ОС.
Настройте шлюз для работы в режиме прокси-сервера

Сконфигурируйте UserGate NGFW для работы в режиме прокси-сервера:

    В верхнем меню выберите Настройки.
    В меню слева перейдите в раздел Сеть ⟶ Зоны.
    Нажмите на имя зоны Trusted.
    Перейдите на вкладку Контроль доступа и включите опцию Консоль администрирования. Нажмите кнопку Сохранить.
    В меню слева перейдите в раздел Сеть ⟶ Интерфейсы.
    Нажмите на имя сетевого интерфейса port0.
    На вкладке Общие в поле Зона выберите из списка зону Trusted. Нажмите кнопку Сохранить.
    В меню слева перейдите в раздел Политики сети ⟶ Межсетевой экран.
    Нажмите на имя предустановленного правила Allow trusted to untrusted.
    Перейдите на вкладку Назначение и отключите зону Untrusted. Нажмите кнопку Сохранить.
    Включите правило Allow trusted to untrusted. Для этого выделите строку с правилом и в верхней части экрана нажмите кнопку Включить.
    В меню слева перейдите в раздел Политики сети ⟶ NAT и маршрутизация.
    Нажмите на имя предустановленного правила NAT from Trusted to Untrusted.
    Перейдите на вкладку Назначение и измените зону назначения с Untrusted на Trusted. Нажмите кнопку Сохранить.
    Включите правило NAT from Trusted to Untrusted. Для этого выделите строку с правилом и в верхней части экрана нажмите кнопку Включить.

На этом первоначальная настройка шлюза закончена. Теперь можно использовать UserGate в качестве прокси-сервера, указав в настройках браузера публичный IP-адрес и порт 8090.
Настройте правила фильтрации трафика

Из политик, предустановленных по умолчанию, рекомендуется использовать Block to botnets, Block from botnets и Example block RU RKN by IP list. Предварительно измените в них значения нескольких параметров:

    Перейдите в раздел Политики сети ⟶ Межсетевой экран.
    Нажмите на имя предустановленного правила.
    Перейдите на вкладку Источник и измените исходную зону с Untrusted на Trusted.
    Перейдите на вкладку Назначение и отключите зону Untrusted.
    Нажмите кнопку Сохранить.
    Включите выбранное правило. Для этого выделите строку с правилом и в верхней части экрана нажмите кнопку Включить.

Для обеспечения большей безопасности настройте дополнительные правила для фильтрации трафика:

    Перейдите в раздел Политики сети ⟶ Межсетевой экран.

    Добавьте первое правило для блокировки:

        В верхней части экрана нажмите кнопку Добавить.

        Укажите параметры правила:
            Название — Блокировка протокола QUIC.
            Действие — Запретить.

        Перейдите на вкладку Источник и выберите Trusted.

        Перейдите на вкладку Сервис.

        Нажмите кнопку Добавить.

        Выберите сервис Quick UDP Internet Connections и нажмите кнопку Добавить. Затем нажмите кнопку Закрыть.

        Нажмите кнопку Сохранить.

    Добавьте второе правило для блокировки:

        В верхней части экрана нажмите кнопку Добавить.

        Укажите параметры правила:
            Название — Блокировка обновлений Windows.
            Действие — Запретить.

        Перейдите на вкладку Источник и выберите Trusted.

        Перейдите на вкладку Приложения.

        Нажмите Добавить ⟶ Добавить приложения.

        Выберите приложение Microsoft Update и нажмите кнопку Добавить.

        Выберите приложение WinUpdate и нажмите кнопку Добавить. Затем нажмите кнопку Закрыть.

        Нажмите кнопку Сохранить.

Вы можете добавить и другие правила для фильтрации трафика. Не рекомендуется совмещать сервисы и приложения в одном правиле. В этом случае правило может не сработать.
Настройте правила фильтрации контента

Из политик, предустановленных по умолчанию, рекомендуется включить Example black list, Example threats sites и Example AV check:

    Перейдите в раздел Политики безопасности ⟶ Фильтрация контента.
    Выделите строку с выбранным правилом и в верхней части экрана нажмите кнопку Включить.

Для обеспечения большей безопасности настройте дополнительные правила для фильтрации контента:

    Перейдите в раздел Политики безопасности ⟶ Фильтрация контента.

    Добавьте правило для фильтрации:

        В верхней части экрана нажмите кнопку Добавить.

        Укажите параметры правила:
            Название — Блокировка социальных сетей.
            Действия — Запретить.

        Перейдите на вкладку Источник и выберите Trusted.

        Перейдите на вкладку Категории.

        Нажмите кнопку Добавить.

        В поисковой строке найдите категорию Социальные сети и нажмите кнопку Добавить. Затем нажмите кнопку Закрыть.

        Нажмите кнопку Сохранить.

Вы можете добавить и другие правила для фильтрации контента. Не рекомендуется совмещать несколько параметров в одном правиле. В этом случае правило может не сработать.
Настройте SSL-инспектирование

По умолчанию UserGate использует для расшифровки трафика свой сертификат CA (Default). Но вы также можете добавить свой собственный сертификат.

Чтобы добавить сертификат:

    Перейдите в раздел UserGate ⟶ Сертификаты.

    В верхней части экрана нажмите кнопку Импорт.

    Заполните параметры сертификата:
        Название — введите произвольное название.
        Файл сертификата — выберите файл сертификата в форматах DER, PEM или PKCS12.
        (Опционально) Приватный ключ — выберите приватный ключ сертификата.
        (Опционально) Пароль — пароль для приватного ключа или контейнера PKCS12.
        (Опционально) Цепочка сертификатов — выберите файл, если необходимо возвращать клиентам полную цепочку сертификатов.

    Нажмите кнопку Сохранить.

    Нажмите на имя добавленного сертификата.

    В поле Используется выберите SSL инспектирование.

    Нажмите кнопку Сохранить.

    Добавьте правило для SSL-инспектирования:

        Перейдите в раздел Политики безопасности ⟶ Инспектирование SSL.

        В верхней части экрана нажмите кнопку Добавить.

        Заполните параметры правила и нажмите кнопку Сохранить.

        Для реализации SSL-инспектирования вы также можете использовать правило по умолчанию Decrypt all for unknown users.
